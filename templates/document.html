{% extends "base.html" %}

{% block title %}Contract Analysis - {{ doc['filename'] }}{% endblock %}

{% block extra_css %}
<style>
    .risk-card { 
        border-left-width: 5px; 
        transition: all 0.3s ease;
    }
    .risk-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    .risk-high { border-left-color: #dc3545; }
    .risk-medium { border-left-color: #ffc107; }
    .risk-low { border-left-color: #198754; }
    .quote {
        background: linear-gradient(135deg, #f8f9fc 0%, #f1f3f8 100%);
        padding: 1.5rem;
        border-radius: 12px;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        border: 2px solid #e3e6f0;
        position: relative;
    }
    .quote::before {
        content: '"';
        position: absolute;
        top: -10px;
        left: 15px;
        font-size: 3rem;
        color: #4e73df;
        background: white;
        padding: 0 10px;
    }
    .progress-modern {
        height: 20px;
        border-radius: 10px;
        background: #e3e6f0;
        overflow: hidden;
    }
    .progress-bar-modern {
        background: linear-gradient(90deg, #4e73df, #36b9cc);
        border-radius: 10px;
        transition: width 0.6s ease;
    }
    .back-link {
        display: inline-flex;
        align-items: center;
        color: #4e73df;
        text-decoration: none;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
        background: rgba(78, 115, 223, 0.1);
    }
    .back-link:hover {
        background: rgba(78, 115, 223, 0.2);
        color: #2653d3;
        transform: translateX(-3px);
    }
    .document-header {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .risk-score-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
    }
    .risk-score-number {
        font-size: 4rem;
        font-weight: bold;
        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="document-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <a href="{{ url_for('index') }}" class="back-link mb-3">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
            <h2 class="mb-1 fw-bold">{{ doc['filename'] }}</h2>
            <p class="text-muted mb-0">Contract Analysis Report</p>
        </div>
        <div class="text-end">
            <div class="bg-primary bg-gradient rounded-3 p-3 d-inline-flex">
                <i class="fas fa-file-contract text-white fa-2x"></i>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="card border-0 shadow-sm" {% if doc.status == 'completed' %}style="display: none;"{% endif %}>
    <div class="card-body text-center p-5">
        <div class="bg-info bg-gradient rounded-circle p-3 d-inline-flex mb-4">
            <i class="fas fa-cogs fa-2x text-white"></i>
        </div>
        <h4 id="loading-status-text" class="fw-bold mb-3">Queueing for processing...</h4>
        <div class="progress-modern mt-3 mb-4">
            <div id="progress-bar" class="progress-bar-modern" role="progressbar" style="width: 5%;" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100">
                <span class="visually-hidden">5% Complete</span>
            </div>
        </div>
        <p class="text-muted mb-0">Your document is being processed. This may take a few moments...</p>
    </div>
</div>

<div id="analysis-results" {% if doc.status != 'completed' %}style="display: none;"{% endif %}>
    <!-- Analysis results will be populated here -->
</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const docId = {{ doc['id'] }};
            const initialStatus = '{{ doc.status }}';
            const initialAnalysis = {{ doc.analysis|tojson if doc.analysis else 'null' }};
            
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('analysis-results');
            const progressBar = document.getElementById('progress-bar');
            const loadingStatusText = document.getElementById('loading-status-text');

            const statusMap = {
                'processing': { percent: 5, text: 'Queueing for processing...' },
                'extracting_text': { percent: 15, text: 'Extracting text from PDF...' },
                'analyzing_openai': { percent: 45, text: 'Analyzing with Primary AI...' },
                'analyzing_deepseek': { percent: 85, text: 'Cross-referencing with Secondary AI...' },
                'combining_results': { percent: 95, text: 'Compiling final report...' },
                'completed': { percent: 100, text: 'Analysis Complete!' }
            };

            function checkStatus() {
                fetch(`/status/${docId}`)
                    .then(response => response.json())
                    .then(data => {
                        const currentStatusInfo = statusMap[data.status];
                        if (currentStatusInfo) {
                            progressBar.style.width = `${currentStatusInfo.percent}%`;
                            progressBar.textContent = `${currentStatusInfo.percent}%`;
                            progressBar.setAttribute('aria-valuenow', currentStatusInfo.percent);
                            loadingStatusText.textContent = currentStatusInfo.text;
                        }

                        if (data.status === 'completed' && data.analysis) {
                            loadingDiv.style.display = 'none';
                            resultsDiv.style.display = 'block';
                            renderAnalysis(data.analysis);
                        } else if (data.status === 'error') {
                            loadingDiv.innerHTML = '<p class="text-danger text-center">An error occurred during analysis. Please try another document.</p>';
                        } else {
                            setTimeout(checkStatus, 2500);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                        loadingDiv.innerHTML = '<p class="text-danger text-center">Could not retrieve analysis status.</p>';
                    });
            }

            function getRiskColor(severity) {
                if (severity > 75) return 'high';
                if (severity > 40) return 'medium';
                return 'low';
            }

            function renderAnalysis(analysis) {
                if (!analysis) {
                    resultsDiv.innerHTML = '<p class="text-danger">Analysis data is missing or invalid.</p>';
                    return;
                }
                
                if (analysis.error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h4><i class="fas fa-exclamation-triangle"></i> Analysis Failed</h4>
                            <p>The analysis could not be completed. The server reported the following issue:</p>
                            <p><strong>${analysis.error}</strong></p>
                        </div>
                    `;
                    return;
                }

                // Calculate overall risk score as an average of clause risks, or display a placeholder
                const clauses = analysis.clauses || [];
                let overallRiskScore = "N/A";
                if (clauses.length > 0) {
                    const totalScore = clauses.reduce((sum, clause) => sum + (clause.risk_score || 0), 0);
                    overallRiskScore = Math.round(totalScore / clauses.length);
                }

                let resultsHTML = `
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="risk-score-card border-0 shadow-sm mb-4">
                                <h6 class="mb-3 opacity-75">Overall Risk Score</h6>
                                <div class="risk-score-number">${overallRiskScore}</div>
                                <p class="mb-0 opacity-75">Out of 100</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                             <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-success bg-gradient rounded-3 p-2 me-3">
                                            <i class="fas fa-chart-line text-white"></i>
                                        </div>
                                        <h5 class="card-title mb-0 fw-bold">Executive Summary</h5>
                                    </div>
                                    <p class="mb-0">${analysis.summary || "No summary provided."}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-warning bg-gradient rounded-3 p-2 me-3">
                            <i class="fas fa-exclamation-triangle text-white"></i>
                        </div>
                        <h3 class="mb-0 fw-bold">Identified Risk Clauses</h3>
                    </div>
                `;

                if (clauses.length > 0) {
                    clauses.forEach(risk => {
                        const riskColor = getRiskColor(risk.risk_score);
                        resultsHTML += `
                            <div class="card risk-card risk-${riskColor} border-0 shadow-sm mb-4">
                                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-${riskColor === 'high' ? 'danger' : riskColor === 'medium' ? 'warning' : 'success'} bg-gradient rounded-3 p-2 me-3">
                                            <i class="fas fa-exclamation-triangle text-white"></i>
                                        </div>
                                        <h5 class="mb-0 fw-bold">${risk.type}</h5>
                                    </div>
                                    <span class="badge bg-${riskColor === 'high' ? 'danger' : riskColor === 'medium' ? 'warning' : 'success'} px-3 py-2">${risk.risk_score} / 100</span>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-4">
                                        <h6 class="fw-semibold mb-2 text-primary">Risk Explanation</h6>
                                        <p class="mb-0">${risk.clause || 'Not available.'}</p>
                                    </div>
                                    <div class="mb-4">
                                        <h6 class="fw-semibold mb-2 text-danger">Consequences</h6>
                                        <p class="mb-0">${risk.consequences || 'Not available.'}</p>
                                    </div>
                                    <div class="mb-4">
                                        <h6 class="fw-semibold mb-2 text-success">Recommendation</h6>
                                        <p class="mb-0">${risk.mitigation || 'Not available.'}</p>
                                    </div>
                                    <div>
                                        <h6 class="fw-semibold mb-3 text-info">Relevant Contract Text</h6>
                                        <div class="quote">
                                            ${risk.exact_text || 'Exact text not extracted.'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    resultsHTML += '<p>No significant risks were identified in this document.</p>';
                }
                resultsDiv.innerHTML = resultsHTML;
            }

            // Initial setup based on server-rendered data
            if (initialStatus === 'completed' && initialAnalysis) {
                renderAnalysis(initialAnalysis);
            } else if (initialStatus !== 'completed' && initialStatus !== 'error') {
                const initialStatusInfo = statusMap[initialStatus];
                if (initialStatusInfo) {
                    progressBar.style.width = `${initialStatusInfo.percent}%`;
                    progressBar.textContent = `${initialStatusInfo.percent}%`;
                    progressBar.setAttribute('aria-valuenow', initialStatusInfo.percent);
                    loadingStatusText.textContent = initialStatusInfo.text;
                }
                setTimeout(checkStatus, 1000); // Start polling
            } else if (initialStatus === 'error') {
                 loadingDiv.innerHTML = '<p class="text-danger text-center">An error occurred during analysis. Please try another document.</p>';
            }
        });
    </script>
{% endblock %}

{% block extra_js %}
<script>
// Additional JavaScript for document page can go here
</script>
{% endblock %} 