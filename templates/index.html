{% extends "base.html" %}

{% block title %}Dashboard - AI Contract Analyzer{% endblock %}

{% block content %}
<div class="row">
    <!-- Upload Section -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>Upload Contract
                </h5>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Drag & Drop PDF Files</h5>
                    <p class="text-muted">or click to browse</p>
                    <p class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Maximum file size: <strong>50MB</strong>
                    </p>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open me-2"></i>Choose File
                    </button>
                </div>
                
                <div id="uploadProgress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center mb-0" id="progressText">Uploading...</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Documents -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Documents
                </h5>
            </div>
            <div class="card-body">
                <div id="documentsList">
                    <p class="text-muted text-center">No documents uploaded yet</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Section -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Analysis Results
                </h5>
            </div>
            <div class="card-body">
                <div id="analysisContent">
                    <div class="text-center text-muted">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <h5>No Analysis Available</h5>
                        <p>Upload a contract to see AI-powered risk analysis</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Details Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Contract Analysis Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                            <i class="fas fa-chart-pie me-2"></i>Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="risks-tab" data-bs-toggle="tab" data-bs-target="#risks" type="button">
                            <i class="fas fa-exclamation-triangle me-2"></i>Risks
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button">
                            <i class="fas fa-dollar-sign me-2"></i>Financial Impact
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="legal-tab" data-bs-toggle="tab" data-bs-target="#legal" type="button">
                            <i class="fas fa-gavel me-2"></i>Legal Obligations
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="analysisTabContent">
                    <div class="tab-pane fade show active" id="overview">
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="risk-score" id="overallRiskScore">
                                    <div class="h1 mb-0">--</div>
                                    <div>Overall Risk Score</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Summary</h6>
                                        <p id="analysisSummary" class="text-muted">No summary available</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="risks">
                        <div class="mt-3" id="risksList">
                            <p class="text-muted text-center">No risks identified</p>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="financial">
                        <div class="mt-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Financial Impact Assessment</h6>
                                    <p id="financialImpact" class="text-muted">No financial impact data available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="legal">
                        <div class="mt-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Legal Obligations</h6>
                                    <ul id="legalObligations" class="list-unstyled">
                                        <li class="text-muted">No legal obligations identified</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDocId = null;

// File upload handling
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadProgress = document.getElementById('uploadProgress');
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            showFileInfo(file);
            handleFiles(files);
        }
    });
    
    uploadArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    // Handle file upload
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        if (files.length === 0) return;
        const file = files[0];

        if (file.size > 50 * 1024 * 1024) {
            alert('File is too large. Maximum size is 50MB.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // Show progress (optional, simple version)
        uploadProgress.style.display = 'block';
        progressText.textContent = 'Uploading...';

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                uploadProgress.style.display = 'none';
                uploadProgress.innerHTML = `<span class="text-danger">${data.error}</span>`;
            } else {
                uploadProgress.style.display = 'none';
                uploadProgress.innerHTML = `<span class="text-success">${data.message}</span>`;
                // Redirect to the new document page
                window.location.href = data.redirect_url;
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            uploadProgress.style.display = 'none';
            uploadProgress.innerHTML = `<span class="text-danger">Upload failed. Please try again.</span>`;
        });
    }

    // Load recent documents
    fetchDocuments();
});

function showFileInfo(file) {
    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
    const maxSize = 50 * 1024 * 1024;
    const isOverLimit = file.size > maxSize;
    
    // Create or update file info display
    let fileInfo = document.getElementById('fileInfo');
    if (!fileInfo) {
        fileInfo = document.createElement('div');
        fileInfo.id = 'fileInfo';
        fileInfo.className = 'mt-3 p-3 border rounded';
        document.getElementById('uploadArea').appendChild(fileInfo);
    }
    
    fileInfo.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <strong>${file.name}</strong>
                <br>
                <small class="text-muted">Size: ${fileSizeMB}MB</small>
            </div>
            <div>
                ${isOverLimit ? 
                    '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Too Large</span>' : 
                    '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Ready</span>'
                }
            </div>
        </div>
    `;
    
    // Remove file info after 5 seconds
    setTimeout(() => {
        if (fileInfo && fileInfo.parentNode) {
            fileInfo.remove();
        }
    }, 5000);
}

function displayAnalysis(analysis) {
    const content = document.getElementById('analysisContent');
    
    if (!analysis) {
        content.innerHTML = '<div class="text-center text-muted"><i class="fas fa-exclamation-circle fa-3x mb-3"></i><h5>Analysis Failed</h5></div>';
        return;
    }
    
    const openaiAnalysis = analysis.openai || {};
    const riskScore = openaiAnalysis.overall_risk_score || 0;
    
    let riskClass = 'risk-low';
    if (riskScore > 70) riskClass = 'risk-high';
    else if (riskScore > 40) riskClass = 'risk-medium';
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="risk-score ${riskClass}">
                    <div class="h1 mb-0">${riskScore}</div>
                    <div>Risk Score</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>Summary</h6>
                        <p class="text-muted">${openaiAnalysis.summary || 'No summary available'}</p>
                        <button class="btn btn-primary btn-sm" onclick="showDetailedAnalysis('${JSON.stringify(analysis).replace(/'/g, "\\'")}')">
                            <i class="fas fa-search me-2"></i>View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function showDetailedAnalysis(analysisJson) {
    const analysis = JSON.parse(analysisJson);
    const openaiAnalysis = analysis.openai || {};
    
    // Update modal content
    document.getElementById('overallRiskScore').innerHTML = `
        <div class="h1 mb-0">${openaiAnalysis.overall_risk_score || 0}</div>
        <div>Overall Risk Score</div>
    `;
    
    document.getElementById('analysisSummary').textContent = openaiAnalysis.summary || 'No summary available';
    document.getElementById('financialImpact').textContent = openaiAnalysis.financial_impact || 'No financial impact data available';
    
    // Update risks list
    const risksList = document.getElementById('risksList');
    if (openaiAnalysis.risks && openaiAnalysis.risks.length > 0) {
        risksList.innerHTML = openaiAnalysis.risks.map(risk => `
            <div class="risk-item ${risk.impact.toLowerCase()}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${risk.type.charAt(0).toUpperCase() + risk.type.slice(1)} Risk</h6>
                        <p class="mb-2">${risk.description}</p>
                        <small class="text-muted">Recommendation: ${risk.recommendation}</small>
                    </div>
                    <span class="badge bg-${risk.impact === 'High' ? 'danger' : risk.impact === 'Medium' ? 'warning' : 'success'}">${risk.severity}</span>
                </div>
            </div>
        `).join('');
    } else {
        risksList.innerHTML = '<p class="text-muted text-center">No risks identified</p>';
    }
    
    // Update legal obligations
    const legalObligations = document.getElementById('legalObligations');
    if (openaiAnalysis.legal_obligations && openaiAnalysis.legal_obligations.length > 0) {
        legalObligations.innerHTML = openaiAnalysis.legal_obligations.map(obligation => 
            `<li><i class="fas fa-check text-success me-2"></i>${obligation}</li>`
        ).join('');
    } else {
        legalObligations.innerHTML = '<li class="text-muted">No legal obligations identified</li>';
    }
    
    // Show modal
    new bootstrap.Modal(document.getElementById('analysisModal')).show();
}

function fetchDocuments() {
    fetch('/documents')
        .then(response => response.json())
        .then(data => {
            const documentsList = document.getElementById('documentsList');
            
            if (data.length === 0) {
                documentsList.innerHTML = '<p class="text-muted text-center">No documents uploaded yet</p>';
                return;
            }
            
            documentsList.innerHTML = data.map(doc => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div>
                        <i class="fas fa-file-pdf text-danger me-2"></i>
                        <span class="fw-bold">${doc.filename}</span>
                        <br>
                        <small class="text-muted">${new Date(doc.created_at).toLocaleDateString()}</small>
                    </div>
                    <span class="badge bg-${getStatusColor(doc.status)}">${doc.status}</span>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading documents:', error);
        });
}

function getStatusColor(status) {
    switch (status) {
        case 'completed': return 'success';
        case 'processing': return 'info';
        case 'extracting_text': return 'info';
        case 'analyzing_openai': return 'primary';
        case 'analyzing_deepseek': return 'primary';
        case 'combining_results': return 'dark';
        case 'analyzing': return 'primary';
        case 'error': return 'danger';
        default: return 'secondary';
    }
}

function renderDocuments(docs) {
    // ... existing code ...
}
</script>
{% endblock %} 